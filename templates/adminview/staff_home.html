{% extends 'base.html' %}

{% block title %}Staff Dashboard - Attendance System{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-chalkboard-teacher me-2"></i>Staff Dashboard
        </h2>
        <p class="text-muted">Welcome, {{ user.get_full_name }}! Manage your classes and monitor attendance.</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="staff-classes-count" class="card-title">{{ classes_count }}</h4>
                        <p class="card-text">Active Classes</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-book fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="staff-total-students" class="card-title">{{ total_students }}</h4>
                        <p class="card-text">Active Students</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="staff-today-attendance" class="card-title">{{ today_attendance }}</h4>
                        <p class="card-text">Today's Attendance</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <a href="{% url 'adminview:class_create' %}" class="btn btn-primary w-100">
                            <i class="fas fa-plus me-2"></i>Create New Class
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        <a href="{% url 'adminview:class_list' %}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-list me-2"></i>Manage Classes
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        <a href="{% url 'adminview:attendance_analytics' %}" class="btn btn-outline-info w-100">
                            <i class="fas fa-chart-bar me-2"></i>View Analytics
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Overall Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6 class="text-muted">Daily Attendance (Last 7 Days)</h6>
                        <canvas id="staffDailyChart" height="180" style="width: 100%;"></canvas>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6 class="text-muted">Class-wise Attendance (%)</h6>
                        <canvas id="staffClassChart" height="180" style="width: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Your Classes -->
<!-- Geo-fences Map Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-map me-2"></i>Geo-fences Map
                </h5>
            </div>
            <div class="card-body">
                <div id="staffMap" style="height: 380px; border-radius: 8px; border: 1px solid #dee2e6;"></div>
            </div>
        </div>
    </div>
    
</div>
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-book me-2"></i>Your Classes
                </h5>
                <a href="{% url 'adminview:class_list' %}" class="btn btn-sm btn-outline-primary">
                    View All
                </a>
            </div>
            <div class="card-body">
                {% if classes %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Class Name</th>
                                    <th>Students</th>
                                    <th>Geo-fence</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for class in classes %}
                                <tr>
                                    <td>
                                        <strong>{{ class.name }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ class.students.count }} students</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ class.geolocation.name }}</span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'adminview:class_edit' class.id %}" 
                                               class="btn btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'adminview:class_enrollment' class.id %}" 
                                               class="btn btn-outline-success">
                                                <i class="fas fa-users"></i>
                                            </a>
                                            <a href="{% url 'adminview:class_delete' class.id %}" 
                                               class="btn btn-outline-danger">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-book fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Classes Yet</h5>
                        <p class="text-muted">You haven't created any classes yet.</p>
                        <a href="{% url 'adminview:class_create' %}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Create Your First Class
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% comment %} Recent Attendance section removed as per requirement {% endcomment %}
{% endblock %}

{% block extra_js %}
{{ block.super }}
{% if google_maps_api_key %}
<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places,drawing&v=weekly" async defer></script>
{% endif %}
<script>
// Staff map functionality for displaying class geo-fences with polygon drawing
(function(){
  const data = JSON.parse('{{ class_geofences_json|default:"[]"|escapejs }}');
  let map, drawingManager, currentPolygon = null;
  
  function init(){
    // Ensure Google Maps API and container are available
    if (typeof window.google === 'undefined' || !google.maps) {
      setTimeout(init, 500);
      return;
    }
    const mapEl = document.getElementById('staffMap');
    if (!mapEl) {
      console.warn('staff_home: #staffMap container not found');
      return;
    }

    map = new google.maps.Map(mapEl, { 
      center: {lat: 0, lng: 0}, 
      zoom: 2,
      mapTypeControl: true,
      streetViewControl: true,
      fullscreenControl: true
    });
    
    // Initialize drawing manager for polygon creation
    drawingManager = new google.maps.drawing.DrawingManager({
      drawingMode: null,
      drawingControl: true,
      drawingControlOptions: {
        position: google.maps.ControlPosition.TOP_CENTER,
        drawingModes: [
          google.maps.drawing.OverlayType.POLYGON,
          google.maps.drawing.OverlayType.MARKER
        ]
      }
    });
    drawingManager.setMap(map);
    
    // Handle polygon completion
    google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
      if (event.type === google.maps.drawing.OverlayType.POLYGON) {
        if (currentPolygon) {
          currentPolygon.setMap(null);
        }
        currentPolygon = event.overlay;
        
        // Get polygon coordinates
        const path = currentPolygon.getPath();
        const coordinates = [];
        for (let i = 0; i < path.getLength(); i++) {
          const point = path.getAt(i);
          coordinates.push({
            lat: point.lat(),
            lng: point.lng()
          });
        }
        
        // Show coordinates info
        showPolygonInfo(coordinates);
        
        // Disable drawing mode
        drawingManager.setDrawingMode(null);
      }
    });
    
    if (data.length === 0) {
      // No classes with geo-fences yet
      const center = map.getCenter();
      const infoWindow = new google.maps.InfoWindow({
        content: '<div class="text-center"><i class="fas fa-info-circle text-info"></i><br><strong>No Classes with Geo-fences Yet</strong><br><small>Create a class and assign a geo-fence to see it displayed here.</small><br><br><small class="text-muted">Use the drawing tools above to create new geo-fences!</small></div>'
      });
      infoWindow.setPosition(center);
      infoWindow.open(map);
      return;
    }
    
    // Display geo-fences for existing classes
    const bounds = new google.maps.LatLngBounds();
    data.forEach(item => {
      if (!item.coordinates || !item.coordinates.length) return;
      const path = item.coordinates.map(c => ({lat: c.lat, lng: c.lng}));
      const polygon = new google.maps.Polygon({ 
        paths: path, 
        strokeColor: '#0d6efd', 
        fillColor: '#0d6efd', 
        fillOpacity: 0.15, 
        strokeOpacity: 0.8, 
        strokeWeight: 2 
      });
      polygon.setMap(map);
      
      // Add info window for the geo-fence
      const infoWindow = new google.maps.InfoWindow({
        content: `<div><strong>${item.class_name}</strong><br><small>Geo-fence: ${item.geofence_name}</small><br><small class="text-muted">Click to view details</small></div>`
      });
      
      google.maps.event.addListener(polygon, 'click', function() {
        infoWindow.setPosition(polygon.getPath().getAt(0));
        infoWindow.open(map);
      });
      
      path.forEach(p => bounds.extend(new google.maps.LatLng(p.lat, p.lng)));
    });
    
    if (!bounds.isEmpty()) {
      map.fitBounds(bounds);
    }
  }
  
  function showPolygonInfo(coordinates) {
    const infoDiv = document.createElement('div');
    infoDiv.innerHTML = `
      <div class="alert alert-info">
        <h6><i class="fas fa-draw-polygon me-2"></i>New Polygon Created!</h6>
        <p class="mb-2">Coordinates: ${coordinates.length} points</p>
        <div class="mb-2">
          <button class="btn btn-sm btn-success me-2" onclick="savePolygonAsGeofence()">
            <i class="fas fa-save me-1"></i>Save as Geo-fence
          </button>
          <button class="btn btn-sm btn-warning" onclick="clearCurrentPolygon()">
            <i class="fas fa-times me-1"></i>Clear
          </button>
        </div>
        <small class="text-muted">Click "Save as Geo-fence" to create a new geo-fence with these coordinates.</small>
      </div>
    `;
    
    // Insert info above the map
    const mapContainer = document.getElementById('staffMap');
    mapContainer.parentNode.insertBefore(infoDiv, mapContainer);
  }
  
  // Global functions for polygon management
  window.savePolygonAsGeofence = function() {
    if (currentPolygon) {
      const path = currentPolygon.getPath();
      const coordinates = [];
      for (let i = 0; i < path.getLength(); i++) {
        const point = path.getAt(i);
        coordinates.push({
          lat: point.lat(),
          lng: point.lng()
        });
      }
      
      // Redirect to geo-fence creation with coordinates
      const coordsJson = encodeURIComponent(JSON.stringify(coordinates));
      window.location.href = `{% url 'adminview:geofence_create' %}?coordinates=${coordsJson}`;
    }
  };
  
  window.clearCurrentPolygon = function() {
    if (currentPolygon) {
      currentPolygon.setMap(null);
      currentPolygon = null;
    }
    // Remove info div
    const infoDiv = document.querySelector('.alert-info');
    if (infoDiv) {
      infoDiv.remove();
    }
  };
  
  function safeInit(){
    if (typeof window.google !== 'undefined' && google.maps) {
      init();
    } else {
      setTimeout(safeInit, 500);
    }
  }
  if (document.readyState !== 'loading') safeInit(); else document.addEventListener('DOMContentLoaded', safeInit);
})();
</script>
<script>
// Auto-refresh staff metrics via JSON API (every 10s). Also refresh when tab becomes visible.
(function(){
  function applyMetrics(data){
    const c = document.getElementById('staff-classes-count');
    const s = document.getElementById('staff-total-students');
    const t = document.getElementById('staff-today-attendance');
    if (c && typeof data.classes_count !== 'undefined') c.textContent = data.classes_count;
    if (s && typeof data.total_students !== 'undefined') s.textContent = data.total_students;
    if (t && typeof data.today_attendance !== 'undefined') t.textContent = data.today_attendance;

    try {
      if (Array.isArray(data.daily_attendance)) {
        drawDailyChart('staffDailyChart', data.daily_attendance);
      }
      if (Array.isArray(data.class_attendance)) {
        drawClassChart('staffClassChart', data.class_attendance);
      }
    } catch (e) { /* ignore render errors */ }
  }
  async function refresh(){
    try{
      const res = await fetch('{% url "adminview:staff_home_metrics" %}', {headers: {"X-Requested-With":"XMLHttpRequest"}});
      if (!res.ok) return;
      const data = await res.json();
      applyMetrics(data);
    }catch(e){ /* ignore transient errors */ }
  }
  refresh();
  // Poll more frequently for near real-time updates
  setInterval(refresh, 10000);
  // Refresh when the tab becomes visible again
  document.addEventListener('visibilitychange', () => { if (!document.hidden) refresh(); });
})();
</script>

<script>
function _canvasSizeToClient(canvas) {
  if (!canvas) return;
  const w = canvas.clientWidth || canvas.width;
  if (w && canvas.width !== w) canvas.width = w;
}

function drawDailyChart(canvasId, series){
  const cv = document.getElementById(canvasId);
  if (!cv) return;
  _canvasSizeToClient(cv);
  const ctx = cv.getContext('2d');
  const W = cv.width;
  const H = cv.height;
  ctx.clearRect(0, 0, W, H);

  const totals = series.map(d => Number(d.total_count || 0));
  const presents = series.map(d => Number(d.present_count || 0));
  const dates = series.map(d => String(d.date || ''));
  const maxY = Math.max(1, ...totals, ...presents);

  const padding = 28;
  const innerW = Math.max(1, W - padding * 2);
  const innerH = Math.max(1, H - padding * 2);

  // baseline
  ctx.strokeStyle = '#dee2e6';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padding, H - padding);
  ctx.lineTo(W - padding, H - padding);
  ctx.stroke();

  function plot(values, color){
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    values.forEach((v, i) => {
      const x = padding + (i * (innerW / Math.max(1, values.length - 1)));
      const y = padding + innerH * (1 - (v / maxY));
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();
  }

  plot(totals, '#6c757d');
  plot(presents, '#0d6efd');

  // x labels (MM-DD)
  ctx.fillStyle = '#6c757d';
  ctx.font = '10px sans-serif';
  dates.forEach((d, i) => {
    const lbl = d.length >= 10 ? d.slice(5) : d;
    const x = padding + (i * (innerW / Math.max(1, dates.length - 1)));
    ctx.fillText(lbl, x - 12, H - 8);
  });
}

function drawClassChart(canvasId, items){
  const cv = document.getElementById(canvasId);
  if (!cv) return;
  _canvasSizeToClient(cv);
  const ctx = cv.getContext('2d');
  const W = cv.width;
  const H = cv.height;
  ctx.clearRect(0, 0, W, H);

  const data = (items || []).slice().sort((a, b) => (Number(b.percentage || 0) - Number(a.percentage || 0))).slice(0, 8);
  const padding = 10;
  const labelW = 80;
  const barH = 14;
  const gap = 8;
  const baseX = padding + labelW;
  const maxW = Math.max(1, W - baseX - padding);

  ctx.fillStyle = '#6c757d';
  ctx.font = '10px sans-serif';
  data.forEach((d, idx) => {
    const name = String(d.class_name || '').slice(0, 10);
    const pct = Math.max(0, Math.min(100, Number(d.percentage || 0)));
    const y = padding + idx * (barH + gap);
    ctx.fillStyle = '#6c757d';
    ctx.fillText(name, padding, y + 11);
    ctx.fillStyle = '#e9ecef';
    ctx.fillRect(baseX, y, maxW, barH);
    ctx.fillStyle = '#198754';
    ctx.fillRect(baseX, y, (pct / 100) * maxW, barH);
    ctx.fillStyle = '#6c757d';
    ctx.fillText(pct.toFixed(0) + '%', baseX + (pct / 100) * maxW + 6, y + 11);
  });
}
</script>
{% endblock %}
